<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCD2åœ–åƒåˆ†é¡æ§åˆ¶ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.4rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #cbd5e0;
        }

        .status-item.connected {
            border-left-color: #48bb78;
        }

        .status-item.disconnected {
            border-left-color: #f56565;
        }

        .status-item.ready {
            border-left-color: #4299e1;
        }

        .status-value {
            font-weight: 600;
            color: #2d3748;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .indicator-green {
            background-color: #48bb78;
            box-shadow: 0 0 10px rgba(72, 187, 120, 0.3);
        }

        .indicator-red {
            background-color: #f56565;
            box-shadow: 0 0 10px rgba(245, 101, 101, 0.3);
        }

        .indicator-yellow {
            background-color: #ed8936;
            box-shadow: 0 0 10px rgba(237, 137, 54, 0.3);
        }

        .indicator-blue {
            background-color: #4299e1;
            box-shadow: 0 0 10px rgba(66, 153, 225, 0.3);
        }

        .control-section {
            margin-bottom: 20px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(45deg, #4299e1, #3182ce);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ed8936, #dd6b20);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f56565, #e53e3e);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .classification-result {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .result-success {
            border-left: 4px solid #48bb78;
        }

        .result-failed {
            border-left: 4px solid #f56565;
        }

        .result-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .result-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .result-label {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .feature-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .feature-label {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 5px;
        }

        .feature-value {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .config-section {
            margin-top: 20px;
        }

        .config-files {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .config-file {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #4299e1;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }

        .alert-error {
            background-color: #fed7d7;
            border: 1px solid #feb2b2;
            color: #742a2a;
        }

        .alert-info {
            background-color: #ebf8ff;
            border: 1px solid #90cdf4;
            color: #2a4365;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #4299e1;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .image-visualization {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .image-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .captured-image {
            max-width: 100%;
            max-height: 500px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .no-image {
            color: #718096;
            font-style: italic;
            padding: 40px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px dashed #cbd5e0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .result-details {
                grid-template-columns: 1fr;
            }
            
            .statistics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CCD2åœ–åƒåˆ†é¡æ§åˆ¶ç³»çµ±</h1>
            <p>å¢å¼·ç‰ˆ - æ•´åˆWebä»‹é¢èˆ‡åœ–åƒåˆ†é¡å¯è¦–åŒ–</p>
        </div>

        <!-- ç³»çµ±ç‹€æ…‹é¢æ¿ -->
        <div class="dashboard">
            <div class="panel">
                <h2>ğŸ”— é€£æ¥ç‹€æ…‹</h2>
                <div class="status-grid">
                    <div id="modbus-status" class="status-item disconnected">
                        <span>Modbus TCP</span>
                        <div class="status-value">
                            é›¢ç·š
                            <span class="status-indicator indicator-red"></span>
                        </div>
                    </div>
                    <div id="camera-status" class="status-item disconnected">
                        <span>ç›¸æ©Ÿé€£æ¥</span>
                        <div class="status-value">
                            é›¢ç·š
                            <span class="status-indicator indicator-red"></span>
                        </div>
                    </div>
                    <div id="config-status" class="status-item disconnected">
                        <span>é…ç½®è¼‰å…¥</span>
                        <div class="status-value">
                            æœªè¼‰å…¥
                            <span class="status-indicator indicator-red"></span>
                        </div>
                    </div>
                    <div id="system-status" class="status-item disconnected">
                        <span>ç³»çµ±ç‹€æ…‹</span>
                        <div class="status-value">
                            æœªå°±ç·’
                            <span class="status-indicator indicator-red"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>âš™ï¸ ç³»çµ±æ§åˆ¶</h2>
                <div class="control-section">
                    <div class="input-group">
                        <input type="text" id="modbus-host" placeholder="Modbusä¸»æ©Ÿåœ°å€" value="127.0.0.1">
                        <input type="number" id="modbus-port" placeholder="ç«¯å£" value="502">
                    </div>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="connectModbus()">é€£æ¥Modbus</button>
                        <button class="btn btn-success" onclick="initializeCamera()">åˆå§‹åŒ–ç›¸æ©Ÿ</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3 style="margin-bottom: 10px; color: #4a5568;">ROIé…ç½®ç®¡ç†</h3>
                    <div class="input-group">
                        <input type="number" id="roi-x" placeholder="ROI X" value="100">
                        <input type="number" id="roi-y" placeholder="ROI Y" value="100">
                        <input type="number" id="roi-width" placeholder="å¯¬åº¦" value="200">
                        <input type="number" id="roi-height" placeholder="é«˜åº¦" value="200">
                    </div>
                    <div class="button-group">
                        <button class="btn btn-warning" onclick="updateJSONROI()">æ›´æ–°JSON ROI</button>
                        <button class="btn btn-primary" onclick="getParameters()">æª¢æŸ¥é…ç½®</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3 style="margin-bottom: 10px; color: #4a5568;">åˆ†é¡æ§åˆ¶</h3>
                    <div class="button-group">
                        <button class="btn btn-warning" onclick="captureAndClassify()">æ‹ç…§+åˆ†é¡</button>
                        <button class="btn btn-primary" onclick="scanConfigFiles()">æƒæé…ç½®</button>
                        <button class="btn btn-success" onclick="loadConfig()">è¼‰å…¥é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆè³‡è¨Š -->
        <div class="panel">
            <h2>ğŸ“Š é‹è¡Œçµ±è¨ˆ</h2>
            <div class="statistics">
                <div class="stat-card">
                    <div id="classification-count" class="stat-number">0</div>
                    <div class="stat-label">åˆ†é¡æ¬¡æ•¸</div>
                </div>
                <div class="stat-card">
                    <div id="error-count" class="stat-number">0</div>
                    <div class="stat-label">éŒ¯èª¤æ¬¡æ•¸</div>
                </div>
                <div class="stat-card">
                    <div id="runtime" class="stat-number">0h 0m</div>
                    <div class="stat-label">é‹è¡Œæ™‚é–“</div>
                </div>
            </div>
        </div>

        <!-- åˆ†é¡çµæœé¡¯ç¤º -->
        <div id="classification-results" class="panel" style="display: none;">
            <h2>ğŸ¯ åˆ†é¡çµæœ</h2>
            <div id="result-content" class="classification-result">
                <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
            </div>
        </div>

        <!-- é…ç½®æª”æ¡ˆç®¡ç† -->
        <div class="panel">
            <h2>ğŸ“ é…ç½®æª”æ¡ˆç®¡ç†</h2>
            <div class="config-section">
                <button class="btn btn-primary" onclick="scanConfigFiles()">ğŸ” æƒææª”æ¡ˆ</button>
                <div id="config-files" class="config-files" style="display: none;">
                    <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>
        </div>

        <!-- åœ–åƒå¯è¦–åŒ– -->
        <div class="image-visualization">
            <div class="panel">
                <h2>ğŸ–¼ï¸ åœ–åƒå¯è¦–åŒ–</h2>
                <div class="image-container">
                    <div id="image-display" class="no-image">
                        å°šæœªæ‹æ”åœ–åƒï¼Œè«‹é»æ“Šã€Œæ‹ç…§+åˆ†é¡ã€æŒ‰éˆ•é–‹å§‹æª¢æ¸¬
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥å€åŸŸ -->
    <div id="notifications" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    </div>

    <script>
        // Socket.IO é€£æ¥
        const socket = io();
        let isConnected = false;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CCD2åˆ†é¡æ§åˆ¶ç³»çµ±å·²è¼‰å…¥');
            requestStatus();
        });

        // Socket.IO äº‹ä»¶è™•ç†
        socket.on('connect', function() {
            console.log('WebSocketå·²é€£æ¥');
            isConnected = true;
            showNotification('WebSocketé€£æ¥æˆåŠŸ', 'success');
        });

        socket.on('disconnect', function() {
            console.log('WebSocketå·²æ–·é–‹');
            isConnected = false;
            showNotification('WebSocketé€£æ¥ä¸­æ–·', 'error');
        });

        socket.on('status_update', function(status) {
            updateStatus(status);
        });

        socket.on('image_update', function(data) {
            if (data.image_data) {
                displayImage(data.image_data);
            }
        });

        // API å‡½æ•¸
        async function connectModbus() {
            const host = document.getElementById('modbus-host').value || '127.0.0.1';
            const port = parseInt(document.getElementById('modbus-port').value) || 502;
            
            try {
                showLoading('é€£æ¥Modbusæœå‹™å™¨ä¸­...');
                const response = await fetch('/api/modbus/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ host, port })
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showNotification('Modbusé€£æ¥æˆåŠŸ', 'success');
                } else {
                    showNotification(`Modbusé€£æ¥å¤±æ•—: ${result.message}`, 'error');
                }
            } catch (error) {
                hideLoading();
                showNotification(`é€£æ¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function initializeCamera() {
            try {
                showLoading('åˆå§‹åŒ–ç›¸æ©Ÿä¸­...');
                const response = await fetch('/api/initialize', {
                    method: 'POST'
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showNotification('ç›¸æ©Ÿåˆå§‹åŒ–æˆåŠŸ', 'success');
                } else {
                    showNotification(`ç›¸æ©Ÿåˆå§‹åŒ–å¤±æ•—: ${result.message}`, 'error');
                }
            } catch (error) {
                hideLoading();
                showNotification(`åˆå§‹åŒ–éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function captureAndClassify() {
            try {
                showLoading('åŸ·è¡Œæ‹ç…§åˆ†é¡ä¸­...');
                const response = await fetch('/api/capture_and_classify', {
                    method: 'POST'
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showNotification('åˆ†é¡æª¢æ¸¬å®Œæˆ', 'success');
                    displayClassificationResult(result);
                    
                    // é¡¯ç¤ºåœ–åƒ
                    if (result.image_data) {
                        displayImage(result.image_data);
                    }
                } else {
                    showNotification(`åˆ†é¡å¤±æ•—: ${result.message}`, 'error');
                    if (result.features) {
                        displayClassificationResult(result);
                    }
                    
                    // å³ä½¿å¤±æ•—ä¹Ÿå˜—è©¦é¡¯ç¤ºåœ–åƒ
                    if (result.image_data) {
                        displayImage(result.image_data);
                    }
                }
            } catch (error) {
                hideLoading();
                showNotification(`åˆ†é¡éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function scanConfigFiles() {
            try {
                showLoading('æƒæé…ç½®æª”æ¡ˆä¸­...');
                const response = await fetch('/api/config/scan');
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    displayConfigFiles(result.files);
                    showNotification(`æ‰¾åˆ° ${result.files.length} å€‹é…ç½®æª”æ¡ˆ`, 'info');
                } else {
                    showNotification(`æƒæå¤±æ•—: ${result.message}`, 'error');
                }
            } catch (error) {
                hideLoading();
                showNotification(`æƒæéŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function updateJSONROI() {
            const roiParams = {
                enabled: true,
                x: parseInt(document.getElementById('roi-x').value) || 100,
                y: parseInt(document.getElementById('roi-y').value) || 100,
                width: parseInt(document.getElementById('roi-width').value) || 200,
                height: parseInt(document.getElementById('roi-height').value) || 200
            };
            
            try {
                showLoading('æ›´æ–°JSONé…ç½®ä¸­çš„ROI...');
                const response = await fetch('/api/update_json_roi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(roiParams)
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showNotification(`JSON ROIå·²æ›´æ–°: (${roiParams.x},${roiParams.y}) ${roiParams.width}Ã—${roiParams.height}`, 'success');
                } else {
                    showNotification(`JSON ROIæ›´æ–°å¤±æ•—: ${result.message}`, 'error');
                }
            } catch (error) {
                hideLoading();
                showNotification(`JSON ROIæ›´æ–°éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function getParameters() {
            try {
                showLoading('è®€å–JSONé…ç½®...');
                const response = await fetch('/api/get_parameters');
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    const params = result.parameters;
                    const categories = result.categories || [];
                    
                    let message = `è™•ç†åƒæ•¸ä¾†æº: JSONé…ç½®æª”æ¡ˆ\n`;
                    message += `ROIå•Ÿç”¨: ${params.roi_enabled}\n`;
                    if (params.roi_enabled) {
                        message += `ROI: (${params.roi_x},${params.roi_y}) ${params.roi_width}Ã—${params.roi_height}\n`;
                    }
                    message += `é«˜æ–¯æ ¸: ${params.gaussian_kernel}, OTSU: ${params.use_otsu}\n`;
                    message += `åˆ†é¡é¡åˆ¥æ•¸: ${categories.length}`;
                    
                    showNotification(message, 'info');
                    console.log('JSONé…ç½®åƒæ•¸:', params);
                    console.log('åˆ†é¡é¡åˆ¥:', categories);
                } else {
                    showNotification(`é…ç½®è®€å–å¤±æ•—: ${result.message}`, 'error');
                }
            } catch (error) {
                hideLoading();
                showNotification(`é…ç½®è®€å–éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function loadConfig() {
            try {
                showLoading('è¼‰å…¥é…ç½®ä¸­...');
                const response = await fetch('/api/config/load', {
                    method: 'POST'
                });
                
                const result = await response.json();
                hideLoading();
                
                if (result.success) {
                    showNotification('é…ç½®è¼‰å…¥æˆåŠŸ', 'success');
                } else {
                    showNotification(`é…ç½®è¼‰å…¥å¤±æ•—: ${result.message}`, 'error');
                }
            } catch (error) {
                hideLoading();
                showNotification(`è¼‰å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function loadLastImage() {
            try {
                const response = await fetch('/api/get_last_image');
                const result = await response.json();
                
                if (result.success && result.image_data) {
                    displayImage(result.image_data);
                }
            } catch (error) {
                console.error('è¼‰å…¥åœ–åƒå¤±æ•—:', error);
            }
        }

        async function requestStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                updateStatus(status);
                
                // å¦‚æœæœ‰åœ–åƒä½†æœªé¡¯ç¤ºï¼Œå˜—è©¦è¼‰å…¥
                if (status.has_image && !document.querySelector('.captured-image')) {
                    loadLastImage();
                }
            } catch (error) {
                console.error('ç²å–ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // UI æ›´æ–°å‡½æ•¸
        function displayImage(imageData) {
            const imageDisplay = document.getElementById('image-display');
            
            if (imageData) {
                imageDisplay.innerHTML = `
                    <img src="${imageData}" alt="åˆ†é¡çµæœåœ–åƒ" class="captured-image">
                    <div style="margin-top: 15px; color: #718096; font-size: 0.9rem;">
                        åœ–åƒåŒ…å«ROIæ¡†ã€ç‰¹å¾µæ•¸å€¼æ¨™è¨»å’Œåˆ†é¡çµæœé¡¯ç¤º
                    </div>
                `;
            } else {
                imageDisplay.className = 'no-image';
                imageDisplay.innerHTML = 'åœ–åƒè¼‰å…¥å¤±æ•—æˆ–æš«ç„¡åœ–åƒæ•¸æ“š';
            }
        }

        function updateStatus(status) {
            // æ›´æ–°é€£æ¥ç‹€æ…‹
            updateStatusItem('modbus-status', status.modbus_connected, 'Modbus TCP', 
                status.modbus_connected ? 'å·²é€£æ¥' : 'é›¢ç·š');
            
            updateStatusItem('camera-status', status.camera_connected, 'ç›¸æ©Ÿé€£æ¥', 
                status.camera_connected ? 'å·²é€£æ¥' : 'é›¢ç·š');
            
            updateStatusItem('config-status', status.config_loaded, 'é…ç½®è¼‰å…¥', 
                status.config_loaded ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥');
            
            // ç³»çµ±ç‹€æ…‹
            let systemStatus = 'æœªçŸ¥';
            let systemConnected = false;
            
            if (status.alarm) {
                systemStatus = 'è­¦å ±';
                systemConnected = false;
            } else if (status.running) {
                systemStatus = 'é‹è¡Œä¸­';
                systemConnected = true;
            } else if (status.ready) {
                systemStatus = 'å°±ç·’';
                systemConnected = true;
            } else if (status.initialized) {
                systemStatus = 'å·²åˆå§‹åŒ–';
                systemConnected = true;
            }
            
            updateStatusItem('system-status', systemConnected, 'ç³»çµ±ç‹€æ…‹', systemStatus);
            
            // æ›´æ–°çµ±è¨ˆè³‡è¨Š
            document.getElementById('classification-count').textContent = status.classification_count || 0;
            document.getElementById('error-count').textContent = status.error_count || 0;
            document.getElementById('runtime').textContent = 
                `${status.runtime_hours || 0}h ${status.runtime_minutes || 0}m`;
            
            // æ›´æ–°æœ€å¾Œçµæœ
            if (status.last_result) {
                displayClassificationResult(status.last_result);
            }
        }

        function updateStatusItem(elementId, connected, label, statusText) {
            const element = document.getElementById(elementId);
            const valueElement = element.querySelector('.status-value');
            const indicator = element.querySelector('.status-indicator');
            
            element.className = `status-item ${connected ? 'connected' : 'disconnected'}`;
            valueElement.innerHTML = `${statusText} <span class="status-indicator ${connected ? 'indicator-green' : 'indicator-red'}"></span>`;
        }

        function displayClassificationResult(result) {
            const resultsPanel = document.getElementById('classification-results');
            const resultContent = document.getElementById('result-content');
            
            const successClass = result.success ? 'result-success' : 'result-failed';
            const statusText = result.success ? `æˆåŠŸåˆ†é¡ç‚ºé¡å‹ ${result.category_id}` : 'åˆ†é¡å¤±æ•—';
            
            resultContent.className = `classification-result ${successClass}`;
            resultContent.innerHTML = `
                <div class="result-header">${statusText}</div>
                <div class="result-details">
                    <div class="result-item">
                        <div class="result-label">é¡åˆ¥ID</div>
                        <div class="result-value">${result.category_id || 0}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">ä¿¡å¿ƒåº¦</div>
                        <div class="result-value">${(result.confidence || 0).toFixed(2)}%</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">åŒ¹é…æ¢ä»¶</div>
                        <div class="result-value">${result.matched_conditions || 0}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">è™•ç†è€—æ™‚</div>
                        <div class="result-value">${((result.processing_time || 0) * 1000).toFixed(0)}ms</div>
                    </div>
                </div>
                ${result.features ? createFeaturesDisplay(result.features) : ''}
            `;
            
            resultsPanel.style.display = 'block';
        }

        function createFeaturesDisplay(features) {
            return `
                <div style="margin-top: 20px;">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">ç‰¹å¾µæ•¸å€¼</h3>
                    <div class="features-grid">
                        <div class="feature-item">
                            <div class="feature-label">å¹³å‡å€¼</div>
                            <div class="feature-value">${(features['å¹³å‡å€¼'] || 0).toFixed(2)}</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-label">æ¨™æº–å·®</div>
                            <div class="feature-value">${(features['æ¨™æº–å·®'] || 0).toFixed(2)}</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-label">ååº¦</div>
                            <div class="feature-value">${(features['ååº¦'] || 0).toFixed(3)}</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-label">å³°åº¦</div>
                            <div class="feature-value">${(features['å³°åº¦'] || 0).toFixed(3)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayConfigFiles(files) {
            const configFilesDiv = document.getElementById('config-files');
            
            if (files.length === 0) {
                configFilesDiv.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">æœªæ‰¾åˆ°é…ç½®æª”æ¡ˆ</div>';
            } else {
                configFilesDiv.innerHTML = files.map(file => 
                    `<div class="config-file">${file}</div>`
                ).join('');
            }
            
            configFilesDiv.style.display = 'block';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            
            const notifications = document.getElementById('notifications');
            notifications.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        function showLoading(message) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-overlay';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                color: white;
                font-size: 1.2rem;
            `;
            loadingDiv.innerHTML = `
                <div style="text-align: center;">
                    <div class="loading" style="margin: 0 auto 20px;"></div>
                    <div>${message}</div>
                </div>
            `;
            
            document.body.appendChild(loadingDiv);
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loading-overlay');
            if (loadingDiv) {
                loadingDiv.parentNode.removeChild(loadingDiv);
            }
        }

        // å®šæœŸæ›´æ–°ç‹€æ…‹
        setInterval(() => {
            if (isConnected) {
                socket.emit('get_status');
            } else {
                requestStatus();
            }
        }, 3000);
    </script>
</body>
</html>