# CCD1視覺檢測模組 YOLOv11版本寄存器映射表 v5.0

## 概述

CCD1視覺檢測模組 YOLOv11版本採用CASE_B/CASE_F分類檢測，基於握手式狀態機控制，使用Modbus TCP Client架構連接主服務器(127.0.0.1:502)。

## 基本信息

- **基地址範圍**: 200-299 (100個寄存器)
- **檢測類型**: YOLOv11物件檢測
- **檢測對象**: CASE_B, CASE_F
- **輪詢頻率**: 50ms
- **版本號**: v5.0

## 完整寄存器映射表

### 1. 核心控制握手寄存器 (200-201)

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 200 | CONTROL_COMMAND | 控制指令 | 0=清空, 8=拍照, 16=拍照+檢測, 32=重新初始化 | R/W |
| 201 | STATUS_REGISTER | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized | R |

### 2. YOLOv11檢測參數寄存器 (210-219)

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 | 預設值 |
|------|------|------|----------|------|--------|
| 210 | CONFIDENCE_HIGH | 置信度閾值高位 | 32位置信度×10000高16位 | R/W | 0 |
| 211 | CONFIDENCE_LOW | 置信度閾值低位 | 32位置信度×10000低16位 | R/W | 8000 |
| 212 | RESERVED_212 | 保留參數1 | 未使用 | R/W | 0 |
| 213 | RESERVED_213 | 保留參數2 | 未使用 | R/W | 0 |
| 214 | RESERVED_214 | 保留參數3 | 未使用 | R/W | 0 |
| 215 | RESERVED_215 | 保留參數4 | 未使用 | R/W | 0 |
| 216-219 | - | 保留區域 | 未使用 | R/W | 0 |

**置信度閾值計算方式**:
- 實際值 = ((CONFIDENCE_HIGH << 16) + CONFIDENCE_LOW) / 10000.0
- 例如: 0.8 → 8000 → HIGH=0, LOW=8000
- 例如: 0.95 → 9500 → HIGH=0, LOW=9500

### 3. YOLOv11檢測結果寄存器 (240-259)

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 240 | CASE_F_COUNT | CASE_F檢測數量 | 0-5 | R |
| 241 | CASE_B_COUNT | CASE_B檢測數量 | 0-255 | R |
| 242 | TOTAL_DETECTIONS | 總檢測數量 | CASE_F + CASE_B | R |
| 243 | DETECTION_SUCCESS | 檢測成功標誌 | 0=失敗, 1=成功 | R |

### 4. CASE_F座標寄存器 (244-253)

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 244 | CASE_F_1_X | CASE_F 1號 X座標 | 像素座標 | R |
| 245 | CASE_F_1_Y | CASE_F 1號 Y座標 | 像素座標 | R |
| 246 | CASE_F_2_X | CASE_F 2號 X座標 | 像素座標 | R |
| 247 | CASE_F_2_Y | CASE_F 2號 Y座標 | 像素座標 | R |
| 248 | CASE_F_3_X | CASE_F 3號 X座標 | 像素座標 | R |
| 249 | CASE_F_3_Y | CASE_F 3號 Y座標 | 像素座標 | R |
| 250 | CASE_F_4_X | CASE_F 4號 X座標 | 像素座標 | R |
| 251 | CASE_F_4_Y | CASE_F 4號 Y座標 | 像素座標 | R |
| 252 | CASE_F_5_X | CASE_F 5號 X座標 | 像素座標 | R |
| 253 | CASE_F_5_Y | CASE_F 5號 Y座標 | 像素座標 | R |
| 254-259 | - | 保留區域 | 未使用 | R |

**說明**:
- 僅輸出CASE_F的座標值，CASE_B僅計數不記錄座標
- 最多記錄5個CASE_F目標的中心點座標
- 未檢測到的目標座標為0

### 5. 世界座標寄存器 (260-279)

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 260 | WORLD_COORD_VALID | 世界座標有效標誌 | 0=無效, 1=有效 | R |
| 261 | CASE_F_1_WORLD_X_HIGH | CASE_F 1號世界X座標高位 | 32位世界X座標×100高16位 | R |
| 262 | CASE_F_1_WORLD_X_LOW | CASE_F 1號世界X座標低位 | 32位世界X座標×100低16位 | R |
| 263 | CASE_F_1_WORLD_Y_HIGH | CASE_F 1號世界Y座標高位 | 32位世界Y座標×100高16位 | R |
| 264 | CASE_F_1_WORLD_Y_LOW | CASE_F 1號世界Y座標低位 | 32位世界Y座標×100低16位 | R |
| 265 | CASE_F_2_WORLD_X_HIGH | CASE_F 2號世界X座標高位 | 32位世界X座標×100高16位 | R |
| 266 | CASE_F_2_WORLD_X_LOW | CASE_F 2號世界X座標低位 | 32位世界X座標×100低16位 | R |
| 267 | CASE_F_2_WORLD_Y_HIGH | CASE_F 2號世界Y座標高位 | 32位世界Y座標×100高16位 | R |
| 268 | CASE_F_2_WORLD_Y_LOW | CASE_F 2號世界Y座標低位 | 32位世界Y座標×100低16位 | R |
| 269 | CASE_F_3_WORLD_X_HIGH | CASE_F 3號世界X座標高位 | 32位世界X座標×100高16位 | R |
| 270 | CASE_F_3_WORLD_X_LOW | CASE_F 3號世界X座標低位 | 32位世界X座標×100低16位 | R |
| 271 | CASE_F_3_WORLD_Y_HIGH | CASE_F 3號世界Y座標高位 | 32位世界Y座標×100高16位 | R |
| 272 | CASE_F_3_WORLD_Y_LOW | CASE_F 3號世界Y座標低位 | 32位世界Y座標×100低16位 | R |
| 273 | CASE_F_4_WORLD_X_HIGH | CASE_F 4號世界X座標高位 | 32位世界X座標×100高16位 | R |
| 274 | CASE_F_4_WORLD_X_LOW | CASE_F 4號世界X座標低位 | 32位世界X座標×100低16位 | R |
| 275 | CASE_F_4_WORLD_Y_HIGH | CASE_F 4號世界Y座標高位 | 32位世界Y座標×100高16位 | R |
| 276 | CASE_F_4_WORLD_Y_LOW | CASE_F 4號世界Y座標低位 | 32位世界Y座標×100低16位 | R |
| 277 | CASE_F_5_WORLD_X_HIGH | CASE_F 5號世界X座標高位 | 32位世界X座標×100高16位 | R |
| 278 | CASE_F_5_WORLD_X_LOW | CASE_F 5號世界X座標低位 | 32位世界X座標×100低16位 | R |
| 279 | CASE_F_5_WORLD_Y_HIGH | CASE_F 5號世界Y座標高位 | 32位世界Y座標×100高16位 | R |

**世界座標計算方式**:
- 實際值(mm) = ((HIGH << 16) + LOW) / 100.0
- 例如: 123.45mm → 12345 → HIGH=0, LOW=12345
- 例如: -67.89mm → -6789 → HIGH=65535, LOW=58747 (補碼)

### 6. 統計資訊寄存器 (280-299)

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 280 | LAST_CAPTURE_TIME | 最後拍照耗時 | 毫秒單位 | R |
| 281 | LAST_PROCESS_TIME | 最後處理耗時 | 毫秒單位 | R |
| 282 | LAST_TOTAL_TIME | 最後總耗時 | 毫秒單位 | R |
| 283 | OPERATION_COUNT | 操作計數器 | 累積成功次數 | R |
| 284 | ERROR_COUNT | 錯誤計數器 | 累積錯誤次數 | R |
| 285 | CONNECTION_COUNT | 連接計數器 | 累積連接次數 | R |
| 286-289 | - | 保留區域 | 未使用 | R |
| 290 | VERSION_MAJOR | 軟體版本主號 | 5 (YOLOv11版本) | R |
| 291 | VERSION_MINOR | 軟體版本次號 | 0 | R |
| 292 | UPTIME_HOURS | 運行時間小時 | 系統運行時間 | R |
| 293 | UPTIME_MINUTES | 運行時間分鐘 | 系統運行時間 | R |
| 294-299 | - | 保留區域 | 未使用 | R |

## 握手協議操作流程

### 1. 基本握手流程

```
1. 系統初始化完成 → 狀態寄存器201=1 (Ready=1)
2. PLC下達控制指令200 → 檢查Ready=1
3. 開始執行 → 狀態寄存器201=2 (Ready=0, Running=1)
4. 執行完成 → 狀態寄存器201=0 (Running=0)
5. PLC清零指令200=0 → 狀態寄存器201=1 (Ready=1, 準備下次)
```

### 2. 拍照+檢測操作序列

```
PLC操作:
1. 檢查狀態寄存器201 bit0=1 (Ready)
2. 寫入控制指令200=16 (拍照+檢測)
3. 等待狀態寄存器201 bit1=0 (Running完成)
4. 讀取檢測結果寄存器240-253
5. 讀取世界座標寄存器260-279 (如需要)
6. 寫入控制指令200=0 (清零)
7. 等待狀態寄存器201 bit0=1 (Ready恢復)
```

### 3. 置信度閾值設定

```
PLC操作:
1. 計算閾值整數值 = 置信度 × 10000
2. 寫入高位寄存器210 = (整數值 >> 16) & 0xFFFF
3. 寫入低位寄存器211 = 整數值 & 0xFFFF
4. 系統自動同步新閾值到YOLOv11檢測器
```

## 典型應用場景

### 場景1: 基本檢測

```python
# PLC Ladder邏輯示例
IF (寄存器201 AND 1) == 1:  # 檢查Ready
    寄存器200 = 16           # 拍照+檢測
    WAIT_UNTIL (寄存器201 AND 2) == 0  # 等待Running完成
    
    case_f_count = 寄存器240    # 讀取CASE_F數量
    case_b_count = 寄存器241    # 讀取CASE_B數量
    
    IF case_f_count > 0:
        case_f_1_x = 寄存器244  # 第一個CASE_F的X座標
        case_f_1_y = 寄存器245  # 第一個CASE_F的Y座標
    
    寄存器200 = 0            # 清零指令
```

### 場景2: 世界座標獲取

```python
# 獲取世界座標
IF 寄存器260 == 1:  # 檢查世界座標有效
    # 獲取第一個CASE_F的世界座標
    world_x_high = 寄存器261
    world_x_low = 寄存器262
    world_y_high = 寄存器263
    world_y_low = 寄存器264
    
    # 組合32位座標值
    world_x_int = (world_x_high << 16) + world_x_low
    world_y_int = (world_y_high << 16) + world_y_low
    
    # 轉換為實際座標 (mm)
    world_x_mm = world_x_int / 100.0
    world_y_mm = world_y_int / 100.0
```

### 場景3: 動態閾值調整

```python
# 設定置信度閾值為0.95
confidence = 0.95
confidence_int = int(confidence * 10000)  # 9500

寄存器210 = (confidence_int >> 16) & 0xFFFF  # 高位 = 0
寄存器211 = confidence_int & 0xFFFF          # 低位 = 9500
```

## 錯誤處理

### 錯誤狀態識別

| 狀態寄存器值 | 二進制 | 含義 | 處理方式 |
|-------------|--------|------|----------|
| 0 | 0000 | 系統未就緒 | 等待初始化完成 |
| 1 | 0001 | Ready正常 | 可下達指令 |
| 2 | 0010 | Running | 等待完成 |
| 4 | 0100 | Alarm | 檢查錯誤原因 |
| 5 | 0101 | Ready+Alarm | 系統警告但可操作 |
| 8 | 1000 | Initialized | 系統已初始化 |
| 9 | 1001 | Ready+Initialized | 正常工作狀態 |

### 常見錯誤排除

1. **檢測失敗 (寄存器243=0)**
   - 檢查相機連接狀態
   - 調整置信度閾值
   - 確認目標物體在視野內

2. **世界座標無效 (寄存器260=0)**
   - 檢查標定檔案是否載入
   - 確認內外參數據有效性

3. **狀態機異常**
   - 使用初始化指令200=32重置系統
   - 檢查Modbus連接狀態

## 性能指標

- **檢測速度**: 通常 < 200ms (拍照+檢測)
- **握手響應**: 50ms輪詢頻率
- **置信度範圍**: 0.1-1.0 (建議0.6-0.95)
- **最大CASE_F數量**: 5個
- **座標精度**: 像素級 + 0.01mm世界座標
- **記憶體使用**: 自動管理，10秒釋放一次

## 版本更新記錄

### v5.0 (YOLOv11版本)
- 完全移除圓形檢測功能
- 新增YOLOv11 CASE_B/CASE_F分類檢測
- 重新設計寄存器映射表
- 僅輸出CASE_F座標值
- 置信度閾值可通過寄存器控制
- 保留世界座標轉換功能
- 優化握手協議響應速度

### v4.0 (原圓形檢測版本)
- 圓形檢測 + 世界座標轉換
- 基地址200-299
- 5個圓形檢測結果輸出