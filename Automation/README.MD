# Modbus狀態機交握地址總表

## 系統架構
主服務器 (ModbusTCP:502) 統一管理所有模組，各模組基地址不重疊。

## 模組基地址分配
| 模組 | 基地址 | 狀態區 | 指令區 | 通訊協議 | 端口 |
|------|--------|--------|--------|----------|------|
| CCD視覺檢測 | 200 | 200-219 | 200-201(握手) | TCP Client + 相機直連 | - |
| VP震動盤 | 300 | 300-314 | 320-324 | TCP → TCP橋接 | 192.168.1.7:1000 |
| 機械臂(規劃) | 400 | 400-449 | - | 待實現 | - |
| Gripper夾爪 | 500 | 500-589 | - | RTU轉TCP橋接 | COM5(三款夾爪) |
| LED控制器 | 600 | 600-615 | 620-624 | RS232轉TCP橋接 | COM6 |
| **角度調整系統** | **700** | **700-739** | **740(控制指令)** | **RTU + TCP混合架構** | **COM5(馬達) + CCD3(800)** |
| **CCD3角度辨識** | **800** | **800-819** | **800-801(握手)** | **TCP Client + 相機直連** | **192.168.1.10** |
| **CCD2圖像分類** | **1000** | **1000-1019** | **1000-1001(握手)** | **TCP Client + 相機直連** | **192.168.1.9** |

## CCD2圖像分類模組 (基地址1000) - 新增

### 握手控制寄存器 (1000-1001)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 1000 | 控制指令 | 0=清空, 8=拍照, 16=拍照+分類檢測, 32=重新初始化, 64=重新載入JSON配置 |
| 1001 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized, bit4=ConfigLoaded |

### 分類參數寄存器 (1010-1019)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 1010 | 高斯模糊核大小 | 奇數值 | 3, 5, 7, 9等 |
| 1011 | 閾值處理模式 | 0=OTSU自動, 1=手動 | 二值化方式 |
| 1012 | 手動閾值 | 0-255 | 手動模式閾值 |
| 1013 | Canny低閾值 | 0-255 | 邊緣檢測參數 |
| 1014 | Canny高閾值 | 0-255 | 邊緣檢測參數 |
| 1015 | LBP半徑 | 1-8 | 紋理分析半徑 |
| 1016 | LBP點數 | 8-32 | 紋理分析點數 |
| 1017 | ROI模式 | 0=關閉, 1=啟用 | ROI區域使用 |
| 1018-1019 | 保留參數 | - | 未來擴展 |

### ROI設定寄存器 (1020-1023)
| 地址 | 功能 | 說明 |
|------|------|------|
| 1020 | ROI X座標 | ROI左上角X |
| 1021 | ROI Y座標 | ROI左上角Y |
| 1022 | ROI寬度 | ROI區域寬度 |
| 1023 | ROI高度 | ROI區域高度 |

### 分類結果寄存器 (1040-1059)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 1040 | 分類成功標誌 | 0=失敗, 1=成功 | 分類結果有效性 |
| 1041 | 分類類別ID | 整數值 | 匹配的類別ID |
| 1042 | 信心度高位 | 32位信心度高16位 | 信心度×100存儲 |
| 1043 | 信心度低位 | 32位信心度低16位 | 信心度×100存儲 |
| 1044 | 匹配條件數量 | 滿足條件數量 | 分類判斷依據 |
| 1045-1049 | 保留結果 | - | 未來擴展 |

### 特徵數值寄存器 (1050-1059)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 1050 | 平均值高位 | 32位平均值高16位 | 亮度平均值×100 |
| 1051 | 平均值低位 | 32位平均值低16位 | 亮度平均值×100 |
| 1052 | 標準差高位 | 32位標準差高16位 | 亮度標準差×100 |
| 1053 | 標準差低位 | 32位標準差低16位 | 亮度標準差×100 |
| 1054 | 偏度高位 | 32位偏度高16位 | 偏度×1000存儲 |
| 1055 | 偏度低位 | 32位偏度低16位 | 偏度×1000存儲 |
| 1056 | 峰度高位 | 32位峰度高16位 | 峰度×1000存儲 |
| 1057 | 峰度低位 | 32位峰度低16位 | 峰度×1000存儲 |
| 1058-1059 | 保留特徵 | - | 未來擴展 |

### 統計資訊寄存器 (1080-1099)
| 地址 | 功能 | 說明 |
|------|------|------|
| 1080 | 最後拍照耗時 | 毫秒單位 |
| 1081 | 最後處理耗時 | 毫秒單位 |
| 1082 | 最後總耗時 | 毫秒單位 |
| 1083 | 分類計數器 | 累積成功次數 |
| 1084 | 錯誤計數器 | 累積錯誤次數 |
| 1085 | JSON載入次數 | 配置重新載入次數 |
| 1090 | 軟體版本主號 | 版本1 |
| 1091 | 軟體版本次號 | 版本0 |
| 1092 | 運行時間小時 | 系統運行時間 |
| 1093 | 運行時間分鐘 | 系統運行時間 |
| 1094-1099 | 保留統計 | 未來擴展 |

## 角度調整系統 (基地址700)

### 狀態寄存器 (700-714)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 700 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized, bit4=CCD_Detecting, bit5=Motor_Moving | 系統狀態位元組 |
| 701 | Modbus連接狀態 | 0=斷開, 1=已連接 | TCP連接到主服務器 |
| 702 | 馬達連接狀態 | 0=斷開, 1=已連接 | RTU連接到馬達驅動器 |
| 703 | 錯誤代碼 | 0=無錯誤, >0=錯誤類型 | 系統錯誤資訊 |
| 704 | 操作計數低位 | 32位操作次數低16位 | 成功執行統計 |
| 705 | 操作計數高位 | 32位操作次數高16位 | 成功執行統計 |
| 706 | 錯誤計數 | 累積錯誤次數 | 失敗操作統計 |
| 707-714 | 保留狀態 | - | 未來擴展使用 |

### 結果寄存器 (720-739)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 720 | 成功標誌 | 0=失敗, 1=成功 | 最後執行結果 |
| 721 | 原始角度高位 | 32位角度高16位 | CCD3檢測角度×100 |
| 722 | 原始角度低位 | 32位角度低16位 | CCD3檢測角度×100 |
| 723 | 角度差高位 | 32位角度差高16位 | 與90度差值×100 |
| 724 | 角度差低位 | 32位角度差低16位 | 與90度差值×100 |
| 725 | 馬達位置高位 | 32位位置高16位 | 計算馬達目標位置 |
| 726 | 馬達位置低位 | 32位位置低16位 | 計算馬達目標位置 |
| 727-729 | 保留結果 | - | 未來擴展使用 |
| 730 | 成功次數低位 | 32位成功次數低16位 | 累積成功統計 |
| 731 | 成功次數高位 | 32位成功次數高16位 | 累積成功統計 |
| 732 | 錯誤次數 | 累積錯誤次數 | 累積失敗統計 |
| 733 | 運行時間 | 系統運行秒數 | 運行時間統計 |
| 734-739 | 保留統計 | - | 未來擴展使用 |

### 控制指令寄存器 (740)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 740 | 控制指令 | 0=清空, 1=角度校正, 2=馬達重置, 7=錯誤重置 | PLC/HMI控制指令 |

## CCD3角度辨識模組 (基地址800)

### 握手控制寄存器 (800-801)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 800 | 控制指令 | 0=清空, 8=拍照, 16=拍照+角度檢測, 32=重新初始化 |
| 801 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized |

### 檢測參數設定 (810-819)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 810 | 檢測模式 | 0=橢圓擬合模式, 1=最小外接矩形模式 | 透過寄存器選擇檢測模式 |
| 811 | 最小面積比例 | 乘以1000存儲 | 0.05 → 50 |
| 812 | 序列模式 | 0=最大輪廓, 1=序列輪廓 | 輪廓選擇方式 |
| 813 | 高斯模糊核大小 | 奇數值 | 3, 5, 7, 9等 |
| 814 | 閾值處理模式 | 0=OTSU自動, 1=手動 | 二值化處理方式 |
| 815 | 手動閾值 | 0-255 | 手動模式使用 |
| 816-819 | 保留參數 | - | 未來擴展使用 |

### 角度檢測結果 (840-859)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 840 | 檢測成功標誌 | 0=失敗, 1=成功 | 檢測結果有效性 |
| 841 | 物體中心X座標 | 像素座標 | 檢測物體中心位置 |
| 842 | 物體中心Y座標 | 像素座標 | 檢測物體中心位置 |
| 843 | 檢測角度高位 | 32位角度高16位 | 角度×100存儲 |
| 844 | 檢測角度低位 | 32位角度低16位 | 角度×100存儲 |
| 845 | 長軸長度 | 像素單位 | 橢圓模式時有效 |
| 846 | 短軸長度 | 像素單位 | 橢圓模式時有效 |
| 847 | 矩形寬度 | 像素單位 | 外接矩形模式時有效 |
| 848 | 矩形高度 | 像素單位 | 外接矩形模式時有效 |
| 849 | 檢測輪廓面積 | 像素平方 | 物體面積資訊 |
| 850 | 內徑高位 | 32位內徑高16位 | 預留擴展使用 |
| 851 | 內徑低位 | 32位內徑低16位 | 預留擴展使用 |
| 852 | 外徑高位 | 32位外徑高16位 | 預留擴展使用 |
| 853 | 外徑低位 | 32位外徑低16位 | 預留擴展使用 |
| 854-859 | 保留結果 | - | 未來擴展使用 |

### 統計資訊 (880-899)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 880 | 最後拍照耗時 | 毫秒單位 | 圖像捕獲時間 |
| 881 | 最後處理耗時 | 毫秒單位 | 角度檢測處理時間 |
| 882 | 最後總耗時 | 毫秒單位 | 完整操作時間 |
| 883 | 操作計數器 | 累積次數 | 成功操作統計 |
| 884 | 錯誤計數器 | 累積次數 | 失敗操作統計 |
| 885 | 連接計數器 | 累積次數 | 連接次數統計 |
| 890 | 軟體版本主號 | 版本號 | 主版本號 |
| 891 | 軟體版本次號 | 版本號 | 次版本號 |
| 892 | 運行時間小時 | 小時數 | 系統運行時間 |
| 893 | 運行時間分鐘 | 分鐘數 | 系統運行時間 |
| 894-899 | 保留統計 | - | 未來擴展使用 |

## VP震動盤模組 (基地址300)

### 狀態寄存器 (只讀 300-314)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 300 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 3=初始化, 4=錯誤 |
| 301 | 設備連接狀態 | 0=斷開, 1=已連接 |
| 302 | 設備狀態 | 0=OFF, 1=ON |
| 303 | 錯誤代碼 | 錯誤編號，0=無錯誤 |
| 304 | 當前動作低位 | 當前動作編碼低16位 |
| 305 | 當前動作高位 | 當前動作編碼高16位 |
| 306 | 目標動作低位 | 目標動作編碼低16位 |
| 307 | 目標動作高位 | 目標動作編碼高16位 |
| 308 | 指令執行狀態 | 0=空閒, 1=執行中 |
| 309 | 通訊錯誤計數 | 累積錯誤次數 |
| 310 | 背光亮度狀態 | 當前背光亮度 (0-255) |
| 311 | 背光開關狀態 | 0=關閉, 1=開啟 |
| 312 | 震動狀態 | 0=停止, 1=運行 |
| 313 | 保留 | 保留欄位 |
| 314 | 時間戳 | 最後更新時間戳 |

### 指令寄存器 (讀寫 320-324)
| 地址 | 功能 | 說明 |
|------|------|------|
| 320 | 指令代碼 | 執行的指令類型 |
| 321 | 參數1 | 強度/亮度/動作碼 |
| 322 | 參數2 | 頻率 |
| 323 | 指令ID | 唯一識別碼，防重複執行 |
| 324 | 保留 | 保留欄位 |

## CCD視覺檢測模組 (基地址200)

### 核心控制握手寄存器 (200-201)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 200 | 控制指令 | 0=清空, 8=拍照, 16=拍照+檢測+保護範圍過濾, 32=重新初始化 |
| 201 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized |

### 檢測參數寄存器 (210-219)
| 地址 | 功能 | 說明 |
|------|------|------|
| 210 | 最小面積高位 | 32位面積設定高16位 |
| 211 | 最小面積低位 | 32位面積設定低16位 |
| 212 | 最小圓度 | 圓度設定值乘以1000 |
| 213 | 高斯核大小 | 圖像處理參數 |
| 214 | Canny低閾值 | 邊緣檢測參數 |
| 215 | Canny高閾值 | 邊緣檢測參數 |

### 像素座標檢測結果寄存器 (240-255)
| 地址 | 功能 | 說明 |
|------|------|------|
| 240 | 檢測圓形數量 | 最多5個 (已過濾的數量) |
| 241-243 | 圓形1像素座標半徑 | X, Y, Radius |
| 244-246 | 圓形2像素座標半徑 | X, Y, Radius |
| 247-249 | 圓形3像素座標半徑 | X, Y, Radius |
| 250-252 | 圓形4像素座標半徑 | X, Y, Radius |
| 253-255 | 圓形5像素座標半徑 | X, Y, Radius |

### 世界座標檢測結果寄存器 (256-276)
| 地址 | 功能 | 說明 |
|------|------|------|
| 256 | 世界座標有效標誌 | 0=無效, 1=有效 |
| 257 | 圓形1世界X座標高位 | 32位世界X座標高16位 (×100) |
| 258 | 圓形1世界X座標低位 | 32位世界X座標低16位 (×100) |
| 259 | 圓形1世界Y座標高位 | 32位世界Y座標高16位 (×100) |
| 260 | 圓形1世界Y座標低位 | 32位世界Y座標低16位 (×100) |
| 261-276 | 其他圓形世界座標 | 圓形2-5世界座標 |

## Gripper夾爪模組 (基地址500)

### 狀態寄存器 (500-589)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 500 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 3=錯誤 |
| 501 | 夾爪連接狀態 | 0=斷開, 1=已連接 |
| 502 | 夾爪狀態 | 夾爪當前狀態 |

## LED控制器模組 (基地址600)

### 狀態寄存器 (600-615)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 600 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 3=錯誤 |
| 601 | LED連接狀態 | 0=斷開, 1=已連接 |
| 602-615 | LED狀態 | 各通道狀態 |

### 指令寄存器 (620-624)
| 地址 | 功能 | 說明 |
|------|------|------|
| 620 | 指令代碼 | 見下方指令表 |
| 621 | 參數1 | 通道號1-4/亮度值 |
| 622 | 參數2 | 亮度值0-511 |
| 623 | 指令ID | 防重複執行 |

### LED指令映射
| 代碼 | 功能 | 參數1 | 參數2 |
|------|------|-------|-------|
| 1 | 全部開啟 | - | - |
| 2 | 全部關閉 | - | - |
| 4 | 設定通道亮度 | 通道1-4 | 亮度0-511 |
| 5 | 開啟通道 | 通道1-4 | - |
| 6 | 關閉通道 | 通道1-4 | - |

## 通用操作規範

### 指令執行標準流程
1. 讀取模組狀態確認Ready
2. 寫入指令代碼和參數
3. 寫入唯一指令ID
4. 等待執行狀態清除
5. 讀取執行結果

### 指令ID機制
- 每次操作使用遞增的唯一ID
- 防止重複執行相同指令
- 指令完成後寄存器自動清零

### 錯誤處理
- 檢查模組狀態判斷連接
- 監控錯誤計數寄存器
- 異常時使用錯誤重置指令(代碼7)

### 32位數值處理
```
# 發送32位數值
高位 = (數值 >> 16) & 0xFFFF
低位 = 數值 & 0xFFFF

# 接收32位數值  
數值 = (高位 << 16) | 低位
```

### CCD世界座標專用處理 (v4.0)
```
# 世界座標轉換為寄存器值 (保留2位小數)
world_coord_int = int(world_coord_mm * 100)
高位 = (world_coord_int >> 16) & 0xFFFF
低位 = world_coord_int & 0xFFFF

# 寄存器值恢復為世界座標
world_coord_int = (高位 << 16) | 低位
world_coord_mm = world_coord_int / 100.0
```

### CCD保護範圍專用處理 (v4.1)
```
# 保護範圍座標轉換為寄存器值 (保留2位小數)
protection_coord_int = int(protection_coord_mm * 100)
高位 = (protection_coord_int >> 16) & 0xFFFF
低位 = protection_coord_int & 0xFFFF

# 寄存器值恢復為保護範圍座標
protection_coord_int = (高位 << 16) | 低位
protection_coord_mm = protection_coord_int / 100.0
```

### CCD3角度專用處理
```
# 角度轉換為寄存器值 (保留2位小數)
angle_int = int(angle_degrees * 100)
高位 = (angle_int >> 16) & 0xFFFF
低位 = angle_int & 0xFFFF

# 寄存器值恢復為角度
angle_int = (高位 << 16) | 低位
angle_degrees = angle_int / 100.0
```

### CCD2分類專用處理
```
# 特徵值轉換為寄存器值 (保留2位小數)
feature_int = int(feature_value * 100)
高位 = (feature_int >> 16) & 0xFFFF
低位 = feature_int & 0xFFFF

# 寄存器值恢復為特徵值
feature_int = (高位 << 16) | 低位
feature_value = feature_int / 100.0

# 偏度/峰度保留3位小數
skew_kurt_int = int(value * 1000)
高位 = (skew_kurt_int >> 16) & 0xFFFF
低位 = skew_kurt_int & 0xFFFF
```

### 角度調整專用處理
```
# 角度校正計算公式
motor_position = 9000 - int(ccd3_angle * 100)
angle_diff = abs(90.0 - ccd3_angle)

# 32位數值寄存器存儲
value_high = (value >> 16) & 0xFFFF
value_low = value & 0xFFFF

# 32位數值寄存器恢復
value = (value_high << 16) | value_low
```

## Web介面端口
| 模組 | Web端口 | 訪問地址 |
|------|---------|----------|
| CCD視覺 | 5051 | localhost:5051 |
| **CCD3角度辨識** | **5052** | **localhost:5052** |
| VP震動盤 | 5053 | localhost:5053 |
| **CCD2圖像分類** | **5054** | **localhost:5054** |
| Gripper夾爪 | 5055 | localhost:5055 |
| LED控制器 | 5008 | localhost:5008 |
| **角度調整系統** | **5087** | **localhost:5087** |

## 系統啟動順序
1. 啟動主Modbus TCP Server (端口502)
2. 啟動各模組主程序
3. 啟動各模組Web應用
4. 透過Web介面或直接寄存器操作控制設備

## CCD2圖像分類模組使用流程 - 新增
1. 啟動CCD2圖像分類系統 (localhost:5054)
2. 連接Modbus服務器 (127.0.0.1:502)
3. 初始化相機 (192.168.1.9)
4. 載入分類條件JSON配置檔案
5. 設置處理參數 (1010-1019寄存器)
6. 設置ROI區域 (1020-1023寄存器)
7. 執行「拍照+分類檢測」指令
8. 讀取分類結果 (1040-1059寄存器)
9. 讀取特徵數值 (1050-1059寄存器)
10. 監控統計資訊 (1080-1099寄存器)

## 角度調整系統使用流程
1. 啟動角度調整主程序 (angle_main.py)
2. 確認馬達驅動器連接 (COM5, Slave 3)
3. 確認Modbus TCP連接 (127.0.0.1:502)
4. 確認CCD3模組運行 (基地址800)
5. 啟動Web介面 (localhost:5087)
6. 透過PLC或Web介面發送角度校正指令
7. 監控執行狀態和結果寄存器
8. 系統自動完成CCD3檢測→計算→馬達補正流程

## 更新記錄

### v7.0 (2024-12-XX) - CCD2圖像分類模組
- **新增模組**: CCD2圖像分類模組 (基地址1000-1099)
- **替換XC100**: 移除XC100升降模組，CCD2使用其基地址1000
- **新增功能**: JSON條件配置驅動的圖像分類系統
- **新增架構**: TCP Client + 相機直連 (192.168.1.9)
- **新增API**: 特徵提取、條件分類、結果輸出完整流程
- **新增Web**: 分類監控Web介面 (端口5054)
- **技術實現**: 握手式狀態機、50ms輪詢、即時分類檢測
- **分類輸出**: 類別ID整數值、信心度、特徵數值完整寄存器映射
- **精度支援**: 平均值/標準差保留2位小數、偏度/峰度保留3位小數

### v6.0 (2024-12-XX) - 角度調整系統
- **新增模組**: 角度調整系統 (基地址700-740)
- **新增功能**: CCD3角度檢測→馬達自動補正完整流程
- **新增架構**: TCP Client + RTU混合通訊架構
- **新增API**: 角度校正、馬達重置、錯誤重置控制
- **新增Web**: 角度調整Web監控介面 (端口5087)
- **技術實現**: 狀態機交握、50ms輪詢、異步指令執行
- **計算公式**: 9000 - CCD3角度×100 = 馬達目標位置
- **精度支援**: 角度和位置32位精度存儲與恢復

### v5.1 (2024-12-XX) - CCD視覺模組保護範圍功能
- **CCD視覺模組升級**: v4.0 → v4.1
- **新增功能**: 保護範圍過濾功能 (基地址200)
- **新增寄存器**: 保護範圍設定寄存器 (294-299, 277-279)
- **更新寄存器**: 統計寄存器功能變更 (284: 有效數量, 285: 過濾數量)
- **新增API**: 保護範圍設定與狀態查詢
- **UI改進**: 保護範圍管理介面、過濾統計顯示
- **過濾邏輯**: 基於世界座標的範圍檢查與物件過濾
- **預設範圍**: X(-122.0~-4.0mm), Y(243.0~341.0mm)
- **版本升級**: CCD視覺模組軟體版本號升級到4.1

### v5.0 (2024-12-XX) - CCD3角度辨識模組
- **新增模組**: CCD3角度辨識模組 (基地址800-899)
- **新增功能**: Ring物件角度檢測，支援橢圓擬合和矩形模式
- **新增寄存器**: 角度檢測參數、結果、統計資訊完整映射
- **新增API**: 角度檢測算法封裝和Web介面控制
- **預留擴展**: 內外徑檢測寄存器 (850-853) 待整合
- **端口分配**: Web端口5052專用於CCD3模組
- **精度支援**: 角度保留2位小數精度 (×100整數存儲)

### v4.0 (2024-12-XX) - CCD視覺模組世界座標功能
- **新增寄存器**: 256-276 世界座標檢測結果區域
- **新增功能**: 內外參NPY檔案管理
- **新增功能**: 像素座標到世界座標轉換 (Z=0平面)
- **擴展API**: 標定檔案掃描、載入、狀態查詢
- **UI改進**: 世界座標狀態顯示、檔案管理介面
- **精度支援**: 世界座標保留2位小數精度 (×100整數存儲)
- **版本升級**: 軟體版本號升級到4.0