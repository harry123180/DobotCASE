# Modbus狀態機交握地址總表

## 系統架構
主服務器 (ModbusTCP:502) 統一管理所有模組，各模組基地址不重疊。

## 模組基地址分配
| 模組 | 基地址 | 狀態區 | 指令區 | 通訊協議 | 端口/IP |
|------|--------|--------|--------|----------|---------|
| CCD1視覺檢測(YOLOv11) | 200 | 200-219 | 200-202(握手) | TCP Client + 相機直連 | 192.168.1.8 |
| VP震動盤 | 300 | 300-314 | 320-324 | TCP → TCP橋接 | 192.168.1.7:1000 |
| 機械臂(舊版) | 400 | 400-449 | 440-449 | 狀態機交握 | 192.168.1.6 |
| Gripper夾爪 | 500 | 500-589 | - | RTU轉TCP橋接 | COM5(三款夾爪) |
| LED控制器 | 600 | 600-615 | 620-624 | RS232轉TCP橋接 | COM6 |
| 角度調整系統 | 700 | 700-739 | 740(控制指令) | RTU + TCP混合架構 | COM5(馬達) + CCD3(800) |
| CCD3角度辨識 | 800 | 800-819 | 800-801(握手) | TCP Client + 相機直連 | 192.168.1.10 |
| CCD2圖像分類 | 1000 | 1000-1019 | 1000-1001(握手) | TCP Client + 相機直連 | 192.168.1.9 |
| 新架構運動類 | 1200 | 1200-1219 | 1240-1249 | 混合交握協議 | 機械臂API + 外部模組 |

## CCD1視覺檢測模組(YOLOv11版本) - 基地址200-299

### 系統架構圖
```
CCD1視覺檢測 (YOLOv11版本) - 基地址200
├── 主程序: CCD1VisionCodeYOLO.py
├── Web介面: Flask+SocketIO (端口5051)
├── 檢測引擎: YOLOv11 (CASE_B/CASE_F/STACK三分類)
├── 通訊架構: TCP Client + 相機直連
├── 相機連接: 192.168.1.8
├── 世界座標: 標定檔案支援座標轉換
└── Modbus連接: 127.0.0.1:502 → 主服務器
```

### 完整寄存器映射

#### 核心控制握手寄存器 (200-206)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 200 | 控制指令 | 0=清空, 8=拍照, 16=拍照+檢測, 32=重新初始化 | PLC控制指令 |
| 201 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized | 系統狀態位元組 |
| 202 | 模型選擇 | 0=未指定, 1-20=模型ID | 動態模型切換 |
| 203 | 拍照完成標誌 | 0=未完成, 1=已完成 | 拍照階段完成 |
| 204 | 檢測完成標誌 | 0=未完成, 1=已完成 | 檢測階段完成 |
| 205 | 操作成功標誌 | 0=失敗, 1=成功 | 整體操作結果 |
| 206 | 錯誤代碼 | 0=無錯誤, >0=錯誤代碼 | 系統錯誤資訊 |

#### YOLOv11檢測參數寄存器 (210-219)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 210 | 置信度閾值高位 | 32位置信度×10000高16位 | 檢測置信度設定 |
| 211 | 置信度閾值低位 | 32位置信度×10000低16位 | 檢測置信度設定 |
| 212-215 | 保留參數 | 未使用 | 未來擴展使用 |
| 216-219 | 保留區域 | 未使用 | 未來擴展使用 |

#### YOLOv11檢測結果寄存器 (240-259)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 240 | CASE_F檢測數量 | 0-5 | CASE_F目標數量 |
| 241 | CASE_B檢測數量 | 0-255 | CASE_B目標數量 |
| 242 | STACK檢測數量 | 0-255 | STACK目標數量 |
| 243 | 總檢測數量 | CASE_F + CASE_B + STACK | 所有目標總數 |
| 244 | 檢測成功標誌 | 0=失敗, 1=成功 | 檢測結果有效性 |

#### CASE_F座標寄存器 (245-254)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 245 | CASE_F 1號 X座標 | 像素座標 | 第1個CASE_F目標X |
| 246 | CASE_F 1號 Y座標 | 像素座標 | 第1個CASE_F目標Y |
| 247 | CASE_F 2號 X座標 | 像素座標 | 第2個CASE_F目標X |
| 248 | CASE_F 2號 Y座標 | 像素座標 | 第2個CASE_F目標Y |
| 249 | CASE_F 3號 X座標 | 像素座標 | 第3個CASE_F目標X |
| 250 | CASE_F 3號 Y座標 | 像素座標 | 第3個CASE_F目標Y |
| 251 | CASE_F 4號 X座標 | 像素座標 | 第4個CASE_F目標X |
| 252 | CASE_F 4號 Y座標 | 像素座標 | 第4個CASE_F目標Y |
| 253 | CASE_F 5號 X座標 | 像素座標 | 第5個CASE_F目標X |
| 254 | CASE_F 5號 Y座標 | 像素座標 | 第5個CASE_F目標Y |

#### 擴展檢測結果寄存器 (255-259)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 255 | CASE_B 1號 X座標 | 像素座標 | 第1個CASE_B目標X |
| 256 | CASE_B 1號 Y座標 | 像素座標 | 第1個CASE_B目標Y |
| 257 | STACK 1號 X座標 | 像素座標 | 第1個STACK目標X |
| 258 | STACK 1號 Y座標 | 像素座標 | 第1個STACK目標Y |
| 259 | 檢測使用模型ID | 實際使用的模型編號 | 本次檢測模型 |

#### 世界座標寄存器 (260-280)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 260 | 世界座標有效標誌 | 0=無效, 1=有效 | 世界座標可用性 |
| 261 | CASE_F 1號世界X座標高位 | 32位世界X座標×100高16位 | 世界座標轉換 |
| 262 | CASE_F 1號世界X座標低位 | 32位世界X座標×100低16位 | 世界座標轉換 |
| 263 | CASE_F 1號世界Y座標高位 | 32位世界Y座標×100高16位 | 世界座標轉換 |
| 264 | CASE_F 1號世界Y座標低位 | 32位世界Y座標×100低16位 | 世界座標轉換 |
| 265-268 | CASE_F 2號世界座標 | 同上格式 | 第2個目標世界座標 |
| 269-272 | CASE_F 3號世界座標 | 同上格式 | 第3個目標世界座標 |
| 273-276 | CASE_F 4號世界座標 | 同上格式 | 第4個目標世界座標 |
| 277-280 | CASE_F 5號世界座標 | 同上格式 | 第5個目標世界座標 |

#### 統計資訊寄存器 (281-299)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 281 | 最後拍照耗時 | 毫秒單位 | 圖像捕獲時間 |
| 282 | 最後處理耗時 | 毫秒單位 | YOLOv11檢測時間 |
| 283 | 最後總耗時 | 毫秒單位 | 完整操作時間 |
| 284 | 操作計數器 | 累積成功次數 | 成功操作統計 |
| 285 | 錯誤計數器 | 累積錯誤次數 | 失敗操作統計 |
| 286 | 連接計數器 | 累積連接次數 | 連接次數統計 |
| 287 | 模型切換次數 | 累積切換次數 | 模型切換統計 |
| 288-289 | 保留區域 | 未使用 | 未來擴展使用 |
| 290 | 軟體版本主號 | 5 (YOLOv11版本) | 主版本號 |
| 291 | 軟體版本次號 | 1 | 次版本號 |
| 292 | 運行時間小時 | 系統運行時間 | 運行時間統計 |
| 293 | 運行時間分鐘 | 系統運行時間 | 運行時間統計 |
| 294-299 | 保留區域 | 未使用 | 未來擴展使用 |

### CCD1 YOLOv11增強版握手協議操作流程

#### 基本握手流程
```
1. 系統初始化完成 → 狀態寄存器201=9 (Ready=1, Initialized=1)
2. PLC下達控制指令200 → 檢查Ready=1
3. 開始執行 → 狀態寄存器201=10 (Ready=0, Running=1, Initialized=1)
4. 執行期間保持Running=1，外部可監控進度
5. 執行完成 → 狀態寄存器201=8 (Running=0, Initialized=1)
6. 設置完成標誌203/204/205=1
7. PLC讀取結果並清零指令200=0
8. 系統檢測到清零 → 狀態寄存器201=9 (Ready=1, Initialized=1)
```

#### 拍照+檢測操作序列
```
PLC操作步驟:
1. 檢查狀態寄存器201 bit0=1 (Ready狀態)
2. (可選) 設置模型選擇寄存器202=N (1-20, 0=使用當前模型)
3. 寫入控制指令200=16 (拍照+檢測)
4. 等待拍照完成標誌203=1
5. 等待檢測完成標誌204=1
6. 檢查操作成功標誌205 (1=成功, 0=失敗)
7. 如果成功，讀取檢測結果:
   - 240: CASE_F數量
   - 241: CASE_B數量  
   - 242: STACK數量
   - 245-254: CASE_F座標
   - 255-258: CASE_B和STACK首個座標
   - 259: 使用的模型ID
8. (可選) 讀取世界座標260-280
9. 寫入控制指令200=0 (清零)
10. 等待狀態寄存器201 bit0=1 (Ready恢復)
```

#### 置信度閾值計算公式
```python
# 實際值轉換為寄存器值 (保留4位小數)
confidence_int = int(confidence_value * 10000)
confidence_high = (confidence_int >> 16) & 0xFFFF
confidence_low = confidence_int & 0xFFFF

# 寄存器值恢復為實際值
confidence_int = (confidence_high << 16) | confidence_low
confidence_value = confidence_int / 10000.0
```

#### 世界座標專用處理
```python
# 世界座標轉換為寄存器值 (保留2位小數)
world_coord_int = int(world_coord_mm * 100)
coord_high = (world_coord_int >> 16) & 0xFFFF
coord_low = world_coord_int & 0xFFFF

# 寄存器值恢復為世界座標
world_coord_int = (coord_high << 16) | coord_low
world_coord_mm = world_coord_int / 100.0
```

## AngleHighLevel模組完整使用情況

### 系統架構圖
```
AngleHighLevel (高階API) - 基地址700
├── 主程序: angle_main.py
├── Web介面: angle_app.py (端口5087)
├── API封裝: AngleHighLevel.py
├── 通訊架構: TCP Client + RTU混合
├── 馬達控制: COM5 → 步進馬達驅動器(Slave 3)
├── 視覺檢測: 調用CCD3模組(基地址800)
└── Modbus連接: 127.0.0.1:502 → 主服務器
```

### 完整寄存器映射

#### 角度調整系統狀態寄存器 (700-714)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 700 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized, bit4=CCD_Detecting, bit5=Motor_Moving | 系統狀態位元組 |
| 701 | Modbus連接狀態 | 0=斷開, 1=已連接 | TCP連接到主服務器 |
| 702 | 馬達連接狀態 | 0=斷開, 1=已連接 | RTU連接到馬達驅動器 |
| 703 | 錯誤代碼 | 0=無錯誤, >0=錯誤類型 | 系統錯誤資訊 |
| 704 | 操作計數低位 | 32位操作次數低16位 | 成功執行統計 |
| 705 | 操作計數高位 | 32位操作次數高16位 | 成功執行統計 |
| 706 | 錯誤計數 | 累積錯誤次數 | 失敗操作統計 |
| 707-714 | 保留狀態 | - | 未來擴展使用 |

#### 角度校正結果寄存器 (720-739)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 720 | 成功標誌 | 0=失敗, 1=成功 | 最後執行結果 |
| 721 | 原始角度高位 | 32位角度高16位 | CCD3檢測角度×100 |
| 722 | 原始角度低位 | 32位角度低16位 | CCD3檢測角度×100 |
| 723 | 角度差高位 | 32位角度差高16位 | 與90度差值×100 |
| 724 | 角度差低位 | 32位角度差低16位 | 與90度差值×100 |
| 725 | 馬達位置高位 | 32位位置高16位 | 計算馬達目標位置 |
| 726 | 馬達位置低位 | 32位位置低16位 | 計算馬達目標位置 |
| 727-729 | 保留結果 | - | 未來擴展使用 |
| 730 | 成功次數低位 | 32位成功次數低16位 | 累積成功統計 |
| 731 | 成功次數高位 | 32位成功次數高16位 | 累積成功統計 |
| 732 | 錯誤次數 | 累積錯誤次數 | 累積失敗統計 |
| 733 | 運行時間 | 系統運行秒數 | 運行時間統計 |
| 734-739 | 保留統計 | - | 未來擴展使用 |

#### 角度校正控制指令寄存器 (740)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 740 | 控制指令 | 0=清空, 1=角度校正, 2=馬達重置, 7=錯誤重置 | PLC/HMI控制指令 |

### AngleHighLevel API使用方法

#### 基本調用範例
```python
from AngleHighLevel import AngleHighLevel, AngleOperationResult

# 方法1: 便利函數 (一次性調用)
from AngleHighLevel import correct_angle_to_90_degrees
result = correct_angle_to_90_degrees()
print(f"結果: {result.result.value}")
print(f"訊息: {result.message}")

# 方法2: 類別實例 (持續性操作)
angle_api = AngleHighLevel()
if angle_api.connect():
    if angle_api.is_system_ready():
        correction_result = angle_api.adjust_to_90_degrees()
        if correction_result.result == AngleOperationResult.SUCCESS:
            print(f"執行成功，角度差: {correction_result.angle_diff:.2f}度")
    angle_api.disconnect()
```

#### 角度校正計算公式
```python
# CCD3檢測角度 → 馬達位置換算
motor_position = 9000 - int(ccd3_angle * 100)
angle_diff = abs(90.0 - ccd3_angle)

# 32位數值寄存器存儲
value_high = (value >> 16) & 0xFFFF
value_low = value & 0xFFFF

# 32位數值寄存器恢復
value = (value_high << 16) | value_low
```

### CCD3角度辨識模組配合使用

#### CCD3模組寄存器 (基地址800)
| 區域 | 地址範圍 | 功能 |
|------|----------|------|
| 握手控制 | 800-801 | 拍照+檢測指令控制 |
| 檢測參數 | 810-819 | 橢圓擬合/矩形模式參數 |
| 檢測結果 | 840-859 | 角度、座標、軸長等結果 |
| 統計資訊 | 880-899 | 操作計數、耗時統計 |

#### AngleHighLevel與CCD3協同流程
```
1. AngleHighLevel.adjust_to_90_degrees()
2. → 調用CCD3拍照檢測 (寄存器800=16)
3. → 讀取CCD3角度結果 (寄存器843-844)
4. → 計算馬達補正位置
5. → 控制馬達移動到目標位置
6. → 寫入結果到寄存器720-739
7. → 返回AngleCorrectionResult
```

## 新架構運動類模組 (基地址1200-1249)

### 混合交握協議架構
```
新架構特點:
├── 運動類Flow (Flow1,2,5): 狀態機交握，序列化執行
├── IO類Flow (Flow3,4): 專用佇列，併行執行  
├── 基地址重新分配: 1200-1249 (避開CCD2衝突)
└── 多執行緒架構: 運動安全性 + IO併行能力
```

#### 運動狀態寄存器 (1200-1219) - 只讀
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 1200 | 運動狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized | 運動類Flow核心控制位 |
| 1201 | 當前運動Flow | 0=無, 1=Flow1, 2=Flow2, 5=Flow5 | 正在執行的運動Flow |
| 1202 | 運動進度 | 0-100百分比 | 當前運動Flow完成度 |
| 1203 | 運動錯誤碼 | 0=無錯誤, >0=錯誤類型 | 運動類錯誤資訊 |
| 1204 | Flow1完成狀態 | 0=未完成, 1=完成且角度校正成功 | Flow1真正完成標誌 |
| 1205 | Flow2完成狀態 | 0=未完成, 1=完成 | Flow2完成標誌 |
| 1206 | Flow5完成狀態 | 0=未完成, 1=完成 | Flow5完成標誌 |
| 1207 | 運動操作計數 | 累積成功次數 | 運動類統計資訊 |
| 1208 | 運動錯誤計數 | 累積錯誤次數 | 運動類統計資訊 |
| 1209 | 運動系統運行時間 | 分鐘數 | 運動類運行時間 |
| 1210-1219 | 保留狀態 | - | 未來擴展使用 |

#### 運動控制寄存器 (1240-1249) - 讀寫
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 1240 | Flow1控制 | 0=清空, 1=啟動VP視覺抓取 | Flow1觸發控制 |
| 1241 | Flow2控制 | 0=清空, 1=啟動出料流程 | Flow2觸發控制 |
| 1242 | Flow5控制 | 0=清空, 1=啟動機械臂運轉 | Flow5觸發控制 |
| 1243 | 運動清除警報 | 0=無動作, 1=清除運動Alarm | 運動類錯誤重置 |
| 1244 | 運動緊急停止 | 0=正常, 1=緊急停止運動 | 運動類安全停止 |
| 1245-1249 | 保留控制 | - | 未來擴展使用 |

### IO類Flow控制寄存器 (447-449) - 讀寫
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 447 | Flow3控制 | 0=清空, 1=啟動翻轉站 | 翻轉站IO控制 (併行) |
| 448 | Flow4控制 | 0=清空, 1=啟動震動投料 | 震動投料IO控制 (併行) |
| 449 | 保留IO控制 | - | 未來IO Flow擴展 |

## CCD2圖像分類模組 (基地址1000-1099)

### 握手控制寄存器 (1000-1001)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 1000 | 控制指令 | 0=清空, 8=拍照, 16=拍照+分類檢測, 32=重新初始化, 64=重新載入JSON配置 |
| 1001 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized, bit4=ConfigLoaded |

### 分類參數寄存器 (1010-1019)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 1010 | 高斯模糊核大小 | 奇數值 | 3, 5, 7, 9等 |
| 1011 | 閾值處理模式 | 0=OTSU自動, 1=手動 | 二值化方式 |
| 1012 | 手動閾值 | 0-255 | 手動模式閾值 |
| 1013 | Canny低閾值 | 0-255 | 邊緣檢測參數 |
| 1014 | Canny高閾值 | 0-255 | 邊緣檢測參數 |
| 1015 | LBP半徑 | 1-8 | 紋理分析半徑 |
| 1016 | LBP點數 | 8-32 | 紋理分析點數 |
| 1017 | ROI模式 | 0=關閉, 1=啟用 | ROI區域使用 |
| 1018-1019 | 保留參數 | - | 未來擴展 |

### ROI設定寄存器 (1020-1023)
| 地址 | 功能 | 說明 |
|------|------|------|
| 1020 | ROI X座標 | ROI左上角X |
| 1021 | ROI Y座標 | ROI左上角Y |
| 1022 | ROI寬度 | ROI區域寬度 |
| 1023 | ROI高度 | ROI區域高度 |

### 分類結果寄存器 (1040-1059)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 1040 | 分類成功標誌 | 0=失敗, 1=成功 | 分類結果有效性 |
| 1041 | 分類類別ID | 整數值 | 匹配的類別ID |
| 1042 | 信心度高位 | 32位信心度高16位 | 信心度×100存儲 |
| 1043 | 信心度低位 | 32位信心度低16位 | 信心度×100存儲 |
| 1044 | 匹配條件數量 | 滿足條件數量 | 分類判斷依據 |
| 1045-1049 | 保留結果 | - | 未來擴展 |

### 特徵數值寄存器 (1050-1059)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 1050 | 平均值高位 | 32位平均值高16位 | 亮度平均值×100 |
| 1051 | 平均值低位 | 32位平均值低16位 | 亮度平均值×100 |
| 1052 | 標準差高位 | 32位標準差高16位 | 亮度標準差×100 |
| 1053 | 標準差低位 | 32位標準差低16位 | 亮度標準差×100 |
| 1054 | 偏度高位 | 32位偏度高16位 | 偏度×1000存儲 |
| 1055 | 偏度低位 | 32位偏度低16位 | 偏度×1000存儲 |
| 1056 | 峰度高位 | 32位峰度高16位 | 峰度×1000存儲 |
| 1057 | 峰度低位 | 32位峰度低16位 | 峰度×1000存儲 |
| 1058-1059 | 保留特徵 | - | 未來擴展 |

### 統計資訊寄存器 (1080-1099)
| 地址 | 功能 | 說明 |
|------|------|------|
| 1080 | 最後拍照耗時 | 毫秒單位 |
| 1081 | 最後處理耗時 | 毫秒單位 |
| 1082 | 最後總耗時 | 毫秒單位 |
| 1083 | 分類計數器 | 累積成功次數 |
| 1084 | 錯誤計數器 | 累積錯誤次數 |
| 1085 | JSON載入次數 | 配置重新載入次數 |
| 1090 | 軟體版本主號 | 版本1 |
| 1091 | 軟體版本次號 | 版本0 |
| 1092 | 運行時間小時 | 系統運行時間 |
| 1093 | 運行時間分鐘 | 系統運行時間 |
| 1094-1099 | 保留統計 | 未來擴展 |

## CCD3角度辨識模組 (基地址800-899)

### 握手控制寄存器 (800-801)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 800 | 控制指令 | 0=清空, 8=拍照, 16=拍照+角度檢測, 32=重新初始化 |
| 801 | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized |

### 檢測參數設定 (810-819)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 810 | 檢測模式 | 0=橢圓擬合模式, 1=最小外接矩形模式 | 透過寄存器選擇檢測模式 |
| 811 | 最小面積比例 | 乘以1000存儲 | 0.05 → 50 |
| 812 | 序列模式 | 0=最大輪廓, 1=序列輪廓 | 輪廓選擇方式 |
| 813 | 高斯模糊核大小 | 奇數值 | 3, 5, 7, 9等 |
| 814 | 閾值處理模式 | 0=OTSU自動, 1=手動 | 二值化處理方式 |
| 815 | 手動閾值 | 0-255 | 手動模式使用 |
| 816-819 | 保留參數 | - | 未來擴展使用 |

### 角度檢測結果 (840-859)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 840 | 檢測成功標誌 | 0=失敗, 1=成功 | 檢測結果有效性 |
| 841 | 物體中心X座標 | 像素座標 | 檢測物體中心位置 |
| 842 | 物體中心Y座標 | 像素座標 | 檢測物體中心位置 |
| 843 | 檢測角度高位 | 32位角度高16位 | 角度×100存儲 |
| 844 | 檢測角度低位 | 32位角度低16位 | 角度×100存儲 |
| 845 | 長軸長度 | 像素單位 | 橢圓模式時有效 |
| 846 | 短軸長度 | 像素單位 | 橢圓模式時有效 |
| 847 | 矩形寬度 | 像素單位 | 外接矩形模式時有效 |
| 848 | 矩形高度 | 像素單位 | 外接矩形模式時有效 |
| 849 | 檢測輪廓面積 | 像素平方 | 物體面積資訊 |
| 850 | 內徑高位 | 32位內徑高16位 | 預留擴展使用 |
| 851 | 內徑低位 | 32位內徑低16位 | 預留擴展使用 |
| 852 | 外徑高位 | 32位外徑高16位 | 預留擴展使用 |
| 853 | 外徑低位 | 32位外徑低16位 | 預留擴展使用 |
| 854-859 | 保留結果 | - | 未來擴展使用 |

### 統計資訊 (880-899)
| 地址 | 功能 | 數值定義 | 說明 |
|------|------|----------|------|
| 880 | 最後拍照耗時 | 毫秒單位 | 圖像捕獲時間 |
| 881 | 最後處理耗時 | 毫秒單位 | 角度檢測處理時間 |
| 882 | 最後總耗時 | 毫秒單位 | 完整操作時間 |
| 883 | 操作計數器 | 累積次數 | 成功操作統計 |
| 884 | 錯誤計數器 | 累積次數 | 失敗操作統計 |
| 885 | 連接計數器 | 累積次數 | 連接次數統計 |
| 890 | 軟體版本主號 | 版本號 | 主版本號 |
| 891 | 軟體版本次號 | 版本號 | 次版本號 |
| 892 | 運行時間小時 | 小時數 | 系統運行時間 |
| 893 | 運行時間分鐘 | 分鐘數 | 系統運行時間 |
| 894-899 | 保留統計 | - | 未來擴展使用 |

## VP震動盤模組 (基地址300)

### 狀態寄存器 (只讀 300-314)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 300 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 3=初始化, 4=錯誤 |
| 301 | 設備連接狀態 | 0=斷開, 1=已連接 |
| 302 | 設備狀態 | 0=OFF, 1=ON |
| 303 | 錯誤代碼 | 錯誤編號，0=無錯誤 |
| 304 | 當前動作低位 | 當前動作編碼低16位 |
| 305 | 當前動作高位 | 當前動作編碼高16位 |
| 306 | 目標動作低位 | 目標動作編碼低16位 |
| 307 | 目標動作高位 | 目標動作編碼高16位 |
| 308 | 指令執行狀態 | 0=空閒, 1=執行中 |
| 309 | 通訊錯誤計數 | 累積錯誤次數 |
| 310 | 背光亮度狀態 | 當前背光亮度 (0-255) |
| 311 | 背光開關狀態 | 0=關閉, 1=開啟 |
| 312 | 震動狀態 | 0=停止, 1=運行 |
| 313 | 保留 | 保留欄位 |
| 314 | 時間戳 | 最後更新時間戳 |

### 指令寄存器 (讀寫 320-324)
| 地址 | 功能 | 說明 |
|------|------|------|
| 320 | 指令代碼 | 執行的指令類型 |
| 321 | 參數1 | 強度/亮度/動作碼 |
| 322 | 參數2 | 頻率 |
| 323 | 指令ID | 唯一識別碼，防重複執行 |
| 324 | 保留 | 保留欄位 |

## Gripper夾爪模組 (基地址500)

### 狀態寄存器 (500-589)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 500 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 3=錯誤 |
| 501 | 夾爪連接狀態 | 0=斷開, 1=已連接 |
| 502 | 夾爪狀態 | 夾爪當前狀態 |

## LED控制器模組 (基地址600)

### 狀態寄存器 (600-615)
| 地址 | 功能 | 數值定義 |
|------|------|----------|
| 600 | 模組狀態 | 0=離線, 1=閒置, 2=執行中, 3=錯誤 |
| 601 | LED連接狀態 | 0=斷開, 1=已連接 |
| 602-615 | LED狀態 | 各通道狀態 |

### 指令寄存器 (620-624)
| 地址 | 功能 | 說明 |
|------|------|------|
| 620 | 指令代碼 | 見下方指令表 |
| 621 | 參數1 | 通道號1-4/亮度值 |
| 622 | 參數2 | 亮度值0-511 |
| 623 | 指令ID | 防重複執行 |

### LED指令映射
| 代碼 | 功能 | 參數1 | 參數2 |
|------|------|-------|-------|
| 1 | 全部開啟 | - | - |
| 2 | 全部關閉 | - | - |
| 4 | 設定通道亮度 | 通道1-4 | 亮度0-511 |
| 5 | 開啟通道 | 通道1-4 | - |
| 6 | 關閉通道 | 通道1-4 | - |

## 通用操作規範

### 指令執行標準流程
1. 讀取模組狀態確認Ready
2. 寫入指令代碼和參數
3. 寫入唯一指令ID
4. 等待執行狀態清除
5. 讀取執行結果

### 指令ID機制
- 每次操作使用遞增的唯一ID
- 防止重複執行相同指令
- 指令完成後寄存器自動清零

### 錯誤處理
- 檢查模組狀態判斷連接
- 監控錯誤計數寄存器
- 異常時使用錯誤重置指令(代碼7)

### 32位數值處理
```
# 發送32位數值
高位 = (數值 >> 16) & 0xFFFF
低位 = 數值 & 0xFFFF

# 接收32位數值  
數值 = (高位 << 16) | 低位
```

### CCD1 YOLOv11世界座標專用處理
```
# 世界座標轉換為寄存器值 (保留2位小數)
world_coord_int = int(world_coord_mm * 100)
高位 = (world_coord_int >> 16) & 0xFFFF
低位 = world_coord_int & 0xFFFF

# 寄存器值恢復為世界座標
world_coord_int = (高位 << 16) | 低位
world_coord_mm = world_coord_int / 100.0
```

### CCD1 YOLOv11置信度專用處理
```
# 置信度轉換為寄存器值 (保留4位小數)
confidence_int = int(confidence_value * 10000)
高位 = (confidence_int >> 16) & 0xFFFF
低位 = confidence_int & 0xFFFF

# 寄存器值恢復為置信度
confidence_int = (高位 << 16) | 低位
confidence_value = confidence_int / 10000.0
```

### CCD3角度專用處理
```
# 角度轉換為寄存器值 (保留2位小數)
angle_int = int(angle_degrees * 100)
高位 = (angle_int >> 16) & 0xFFFF
低位 = angle_int & 0xFFFF

# 寄存器值恢復為角度
angle_int = (高位 << 16) | 低位
angle_degrees = angle_int / 100.0
```

### CCD2分類專用處理
```
# 特徵值轉換為寄存器值 (保留2位小數)
feature_int = int(feature_value * 100)
高位 = (feature_int >> 16) & 0xFFFF
低位 = feature_int & 0xFFFF

# 寄存器值恢復為特徵值
feature_int = (高位 << 16) | 低位
feature_value = feature_int / 100.0

# 偏度/峰度保留3位小數
skew_kurt_int = int(value * 1000)
高位 = (skew_kurt_int >> 16) & 0xFFFF
低位 = skew_kurt_int & 0xFFFF
```

### 角度調整專用處理
```
# 角度校正計算公式
motor_position = 9000 - int(ccd3_angle * 100)
angle_diff = abs(90.0 - ccd3_angle)

# 32位數值寄存器存儲
value_high = (value >> 16) & 0xFFFF
value_low = value & 0xFFFF

# 32位數值寄存器恢復
value = (value_high << 16) | value_low
```

## Web介面端口
| 模組 | Web端口 | 訪問地址 |
|------|---------|----------|
| CCD1視覺(YOLOv11) | 5051 | localhost:5051 |
| CCD3角度辨識 | 5052 | localhost:5052 |
| VP震動盤 | 5053 | localhost:5053 |
| CCD2圖像分類 | 5054 | localhost:5054 |
| Gripper夾爪 | 5055 | localhost:5055 |
| LED控制器 | 5008 | localhost:5008 |
| 角度調整系統 | 5087 | localhost:5087 |
| 新架構運動類 | 待分配 | localhost:待分配 |

## 系統啟動順序
1. 啟動主Modbus TCP Server (端口502)
2. 啟動各模組主程序
3. 啟動各模組Web應用
4. 透過Web介面或直接寄存器操作控制設備

## CCD1 YOLOv11視覺檢測使用流程
1. 啟動CCD1視覺檢測系統 (localhost:5051)
2. 連接Modbus服務器 (127.0.0.1:502)
3. 初始化相機 (192.168.1.8)
4. 載入YOLOv11模型檔案 (model_1.pt ~ model_20.pt)
5. 設置檢測參數 (210-219寄存器)
6. (可選) 選擇模型 (202寄存器)
7. 執行「拍照+檢測」指令 (200=16)
8. 讀取檢測結果 (240-259寄存器)
9. (可選) 讀取世界座標 (260-280寄存器)
10. 監控統計資訊 (281-299寄存器)

## 角度調整系統使用流程
1. 啟動角度調整主程序 (angle_main.py)
2. 確認馬達驅動器連接 (COM5, Slave 3)
3. 確認Modbus TCP連接 (127.0.0.1:502)
4. 確認CCD3模組運行 (基地址800)
5. 啟動Web介面 (localhost:5087)
6. 透過PLC或Web介面發送角度校正指令
7. 監控執行狀態和結果寄存器
8. 系統自動完成CCD3檢測→計算→馬達補正流程

## 新架構運動類模組使用流程
1. 啟動新架構主程序 (Dobot_main.py)
2. 確認機械臂API連接 (192.168.1.6)
3. 確認Modbus TCP連接 (127.0.0.1:502)
4. 確認外部模組連接 (CCD1, Gripper, Angle)
5. 透過寄存器1240-1244控制Flow執行
6. 監控運動狀態寄存器1200-1209
7. 系統自動完成運動+IO併行控制

## CCD2圖像分類模組使用流程
1. 啟動CCD2圖像分類系統 (localhost:5054)
2. 連接Modbus服務器 (127.0.0.1:502)
3. 初始化相機 (192.168.1.9)
4. 載入分類條件JSON配置檔案
5. 設置處理參數 (1010-1019寄存器)
6. 設置ROI區域 (1020-1023寄存器)
7. 執行「拍照+分類檢測」指令
8. 讀取分類結果 (1040-1059寄存器)
9. 讀取特徵數值 (1050-1059寄存器)
10. 監控統計資訊 (1080-1099寄存器)

## 更新記錄

### v9.0 - CCD1模組YOLOv11版本
- **CCD1模組更新**: 從圓形檢測更新為YOLOv11版本
- **檢測類型**: CASE_B/CASE_F/STACK三分類檢測
- **模型管理**: 支援1-20個模型動態切換 (model_1.pt ~ model_20.pt)
- **置信度控制**: 透過寄存器210-211動態調整檢測閾值
- **增強握手**: 新增完成標誌寄存器203-206提升操作可靠性
- **世界座標**: 保留標定檔案支援的座標轉換功能
- **性能提升**: 檢測速度通常<300ms，支援50ms握手輪詢

### v8.0 - 新架構地址配置
- **新架構運動類**: 基地址1200-1249避免模組衝突
- **AngleHighLevel**: 完整角度調整系統文檔
- **混合交握協議**: 運動類Flow狀態機交握 + IO類Flow專用佇列併行
- **系統穩定性**: 解決模組間地址衝突問題

### v7.0 - CCD2圖像分類模組
- **CCD2圖像分類**: 基地址1000-1099
- **JSON條件配置**: 驅動的圖像分類系統
- **特徵提取**: 完整的分類流程和結果輸出
- **精度支援**: 平均值/標準差保留2位小數、偏度/峰度保留3位小數

### v6.0 - 角度調整系統
- **角度調整系統**: 基地址700-740
- **CCD3角度檢測**: 馬達自動補正完整流程
- **混合通訊架構**: TCP Client + RTU混合架構
- **計算公式**: 9000 - CCD3角度×100 = 馬達目標位置